---
# yaml-language-server: $schema=https://json.schemastore.org/github-action.json
name: 'C# Lint Check'
description: 'Runs linters like StyleCop or dotnet-format for C# code style checks.'
author: 'Ismo Vuorinen'

branding:
  icon: 'code'
  color: 'blue'

inputs:
  dotnet-version:
    description: 'Version of .NET SDK to use.'
    required: false

runs:
  using: composite
  steps:
    - name: Validate Inputs
      id: validate
      shell: bash
      run: |
        set -euo pipefail

        # Validate .NET version format if provided
        if [[ -n "${{ inputs.dotnet-version }}" ]]; then
          if ! [[ "${{ inputs.dotnet-version }}" =~ ^[0-9]+(\.[0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "::error::Invalid dotnet-version format: '${{ inputs.dotnet-version }}'. Expected format: X.Y or X.Y.Z (e.g., 7.0, 8.0.100)"
            exit 1
          fi

          # Check for reasonable version range (prevent malicious inputs)
          major_version=$(echo "${{ inputs.dotnet-version }}" | cut -d'.' -f1)
          if [ "$major_version" -lt 3 ] || [ "$major_version" -gt 20 ]; then
            echo "::error::Invalid dotnet-version: '${{ inputs.dotnet-version }}'. Major version should be between 3 and 20"
            exit 1
          fi
        fi

        echo "Input validation completed successfully"

    - name: Detect .NET SDK Version
      uses: ivuorinen/actions/dotnet-version-detect@main
      with:
        default-version: '7.0'

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
      with:
        dotnet-version: ${{ steps.detect-dotnet-version.outputs.dotnet-version }}

    - name: Install dotnet-format
      shell: bash
      run: |
        set -euo pipefail

        dotnet tool install --global dotnet-format --version 7.0.1

    - name: Run dotnet-format
      shell: bash
      run: |
        set -euo pipefail

        if ! dotnet format --check --report sarif --report-file dotnet-format.sarif; then
          echo "::error::Code formatting issues found. Check the SARIF report for details."
          exit 1
        fi

    - name: Upload SARIF Report
      uses: github/codeql-action/upload-sarif@64d10c13136e1c5bce3e5fbde8d4906eeaafc885 # v3.30.6
      with:
        sarif_file: dotnet-format.sarif
